\documentclass[11pt,a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{helvet}
\usepackage{amsmath}
\usepackage[margin=1in]{geometry}
\usepackage{graphicx}
\usepackage{float}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{colortbl}
\usepackage{array}
\usepackage[spanish,es-tabla]{babel}

% Colors
\definecolor{primary}{RGB}{0, 47, 135}
\definecolor{secondary}{RGB}{204, 0, 0}
\definecolor{accent}{RGB}{240, 240, 240}
\definecolor{purple_iquall}{RGB}{40, 27, 47}


\usepackage{tikz}

% Iquall color palette (approx.)
\definecolor{iquallPurple}{HTML}{6B1F83}
\definecolor{iquallMagenta}{HTML}{E23B8E}
\definecolor{iquallBg}{HTML}{F7F3FB}

% Fonts
\renewcommand{\familydefault}{\sfdefault}

% Fix for headheight warning
\setlength{\headheight}{33pt}

% Header and Footer
\pagestyle{fancy}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\includegraphics[height=0.8cm]{imgs_exec/logo.png}} 
\fancyfoot[C]{\thepage}
\fancyfoot[R]{\small \today}

% Section styling
\titleformat{\section}
{\color{primary}\Large\bfseries}
{\thesection}{1em}{}[\titlerule]

\titleformat{\subsection}
{\color{primary}\large\bfseries}
{\thesubsection}{1em}{}

\usepackage{datetime}
\usepackage{advdate}

\makeatletter
\newcommand{\TemporalRangeDays}[1]{%
  \begingroup
    \AdvanceDate[-#1]%
    \the\day\ de \ifcase\month\or enero\or febrero\or marzo\or abril\or mayo\or junio\or julio\or agosto\or septiembre\or octubre\or noviembre\or diciembre\fi\ de \the\year\space-\\[0pt]
    \AdvanceDate[#1]%
    \the\day\ de \ifcase\month\or enero\or febrero\or marzo\or abril\or mayo\or junio\or julio\or agosto\or septiembre\or octubre\or noviembre\or diciembre\fi\ de \the\year
  \endgroup
}
\makeatother



\begin{document}


% --- Cover Page ---
\begin{titlepage}
    \thispagestyle{empty}
    \begin{tikzpicture}[remember picture,overlay]
        % Header image band
        \node[anchor=north west, inner sep=0pt] at (current page.north west)
            {\includegraphics[width=\paperwidth,height=7.2cm]{imgs_exec/header-city-1.jpg}};
        % Footer band (Iquall accent)
        \fill[purple_iquall] (current page.south west) rectangle ([yshift=1.35cm]current page.south east);
        \fill[purple_iquall] (current page.south west) rectangle ([yshift=1.50cm]current page.south east);
    \end{tikzpicture}

    \vspace*{-0.2cm}
    % Header content (logos)
    \noindent
    
    \begin{minipage}{\textwidth}
        % Iquall logo: top-right (same size)

        \vspace*{1cm}
        %\begin{flushright}
        %    \includegraphics[height=1.25cm, keepaspectratio]{imgs_exec/logo.png}
        %\end{flushright}
        % Telcel logo: centered, slightly lower, 10% larger than Iquall
        \vspace{4.50cm}
        \begin{center}
            \includegraphics[height=1.5cm, keepaspectratio]{imgs_exec/telcel.png}
        \end{center}
    \end{minipage}

    % Flexible spacing to vertically center the cover content between header and footer bands
    \vspace{1.2cm}
    \vfill

    % Main title block
    \begin{center}
        {\color{primary}\Huge \bfseries Reporte de Planificación de Capacidad}\par
        \vspace{0.35cm}
        {\Large \bfseries \VAR{country} -- Estado de la Infraestructura y Visión General Estratégica}\par
        \vspace{0.7cm}
        {\color{primary}\rule{0.75\linewidth}{0.6pt}}\par
    \end{center}

    \vspace{0.9cm}

    % Info box
    \begin{flushright}
        \begin{tikzpicture}
            \node[
                fill=accent,
                rounded corners=6pt,
                inner sep=10pt
            ] {
                \begin{minipage}{0.8\textwidth}
                  \raggedleft
                  \textbf{Fecha:} \today \\[2pt]
                  \textbf{Rango Temporal: }%
                  \TemporalRangeDays{14} \\[2pt]
                  \textbf{Alcance:} País -- \VAR{country} \\[4pt]
                  \small
                  \textbf{Regiones:} \VAR{region_list_str} \\[4pt]
                  \textbf{Document Version:} 0.2 - Draft \\[4pt]
                \end{minipage}
            };
        \end{tikzpicture}
    \end{flushright}

    \vfill
    \vspace{0.35cm}

    \begin{center}
        {\small \textit{Preparado para Telcel por Iquall Networks}}
    \end{center}
\end{titlepage}

% --- Disclaimer Page ---
\newpage
\thispagestyle{empty}
\vspace*{5cm}
\begin{minipage}{\textwidth}
\centering
\rule{\textwidth}{0.4pt} \\
\vspace{0.3cm}
\textbf{CONFIDENCIAL} \\
Este documento contiene información propietaria perteneciente a Iquall Networks. \\
Su distribución o reproducción no autorizada está estrictamente prohibida. \\

\vspace{0.5cm}

\textbf{DESCARGO DE RESPONSABILIDAD} \\
Este análisis se basa en datos recopilados durante el período de tiempo especificado y representa una instantánea del rendimiento del sistema en ese momento. Los resultados y recomendaciones pueden variar según cambios en el sistema, patrones de carga o modificaciones en la infraestructura. \\


\vspace{0.5cm}
\textbf{CONTENIDO PRELIMINAR} \\
Toda la información contenida en este reporte es provisoria y se encuentra en proceso de trabajo. \\


\vspace{0.3cm}
\rule{\textwidth}{0.4pt}
\end{minipage}
\newpage

% --- Table of Contents ---
\tableofcontents
\newpage

% --- Content Starts Here ---
\section{Visión General del País}

Este reporte se enfoca en la infraestructura del \textbf{vendor Ericsson} desplegada a lo largo de los Data Centers de \textbf{\VAR{country}}, abarcando las \textbf{Regiones \VAR{region_list_str}}. La siguiente tabla proporciona un resumen de alto nivel del alcance considerado, detallando el número total de clusters, servidores físicos y máquinas virtuales desplegadas en cada Data Center.

\begin{table}[H]
\centering
\caption{Resumen de Data Centers -- \VAR{country}}
\label{tab:overview}
\footnotesize
\setlength{\tabcolsep}{4pt}
\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}}clrrrrr@{}}
\toprule
\textbf{Región} & \textbf{Data Center} & \textbf{Clusters} & \textbf{Serv. Totales} & \textbf{Serv. Spare} & \textbf{Tipos VNF} & \textbf{VMs} \\
\midrule
    \BLOCK{ for overview in overview_list }
        \VAR{overview.region} &
        \VAR{overview.dc} &
        \VAR{overview.clusters} &
        \VAR{overview.total_servers} &
        \VAR{overview.spare_servers} (\VAR{overview.spare_pct}\%) &
        \VAR{overview.vnf_types} &
        \VAR{overview.vms} \\
        \BLOCK{ if overview.region_last }
\midrule
        \BLOCK{ endif }
    \BLOCK{ endfor }
    \multicolumn{2}{l}{\textbf{\VAR{total_overview.dc}}} &
    \textbf{\VAR{total_overview.clusters}} &
    \textbf{\VAR{total_overview.total_servers}} &
    \textbf{\VAR{total_overview.spare_servers} (\VAR{total_overview.spare_pct}\%)} &
    \textbf{\VAR{total_overview.vnf_types}} &
    \textbf{\VAR{total_overview.vms}} \\
\bottomrule
\end{tabular*}
\end{table}


\section{Análisis de Capacidad del País}

La siguiente figura presenta el resumen global de los recursos de \textbf{\VAR{country}} (vCPU, Memoria y Disco), consolidando todos los Data Centers a nivel nacional y desglosando la capacidad total en categorías de reservado, sistema, libre, fragmentación (vCPU) y spare.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\textwidth]{\detokenize{\VAR{fig1_path}}}
    \caption{Resumen Global de Capacidad: vCPU, Memoria y Disco}
    \label{fig:spare_dist}
    \end{figure}

    \noindent \small{\textbf{Notas:}}
    \begin{itemize}
        \setlength\itemsep{0em}
        \item \small{\textit{Reservado:} Recursos efectivamente comprometidos o en uso por las máquinas virtuales desplegadas.
        \item \small{\textit{Fragmentación:} Ocurre cuando los recursos remanentes en un servidor, tras la asignación de VMs, son insuficientes para alojar nuevas instancias operativas. En el contexto de este reporte, se contabilizan como pérdida por fragmentación aquellos servidores que presentan 4 o menos vCPUs libres, 4 GB o menos de memoria libre, o 10 GB o menos de disco libre.}
        \item \small{\textit{Libre:} Representa la porción de recursos (CPU, RAM, Disco) que se encuentra efectivamente disponible para ser asignada a nuevas VNFs o cargas de trabajo.}
        \item \small{\textit{Sistema:} Corresponde a los recursos reservados para el funcionamiento del sistema operativo del servidor y la capa de virtualización. Estos recursos no son utilizables para la carga de VNFs.}
        \item \small{\textit{Spare:} Se utiliza el criterio de considerar \textit{Spare} a todo servidor que no tenga ninguna VM instanciada.
    \end{itemize}

\subsection{Matriz de Utilización Efectiva vs Reserva Efectiva}

La siguiente matriz presenta una vista comparativa de la \textbf{utilización efectiva} y la \textbf{reserva efectiva} a nivel nacional (\textbf{\VAR{country}}). Para las definiciones formales de estos términos y del escenario de \textbf{failover}, consultar el Anexo (\ref{sec:definiciones_utilizacion}).

\begin{figure}[H]
\centering

\begin{minipage}[t]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{\detokenize{\VAR{fig4_cpu_path}}}
    \vspace{2mm}
    {\small \textbf{CPU - STORAGE}}
\end{minipage}\hfill
\begin{minipage}[t]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{\detokenize{\VAR{fig4_mem_path}}}
    \vspace{2mm}
    {\small \textbf{RAM}}
\end{minipage}

\caption{Utilización Efectiva vs Reserva Efectiva del País}
\label{fig:country_effective_capacity}
\end{figure}



\begin{table}[H]
\centering
\caption{Métricas de Reserva y Utilización Efectiva por Región (Respecto a la Capacidad Neta)}
\label{tab:country_matrix_values}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}l|ccc|ccc|ccc@{}}
\toprule
& \multicolumn{3}{c|}{\textbf{CPU}} & \multicolumn{3}{c|}{\textbf{Memoria}} & \multicolumn{3}{c}{\textbf{Disco Local}} \\
\textbf{Región} & Cap. Neta & Res. Ef. (\%) & Util. Ef. (\%) & Cap. Neta & Res. Ef. (\%) & Util. Ef. (\%) & Cap. Neta & Res. Ef. (\%) & Util. Ef. (\%) \\
\midrule
    \BLOCK{ for metric in region_metrics }
        Región \VAR{metric.region} &
        \VAR{metric.cap_neta_cpu} vCPU &
        \VAR{metric.efect_resv_cpu_pct | fmt_num} &
        \VAR{metric.efect_util_cpu | fmt_num} &
        \VAR{ (metric.cap_neta_mem / 1000) | fmt_num } TB &
        \VAR{metric.efect_resv_mem_pct | fmt_num} &
        \VAR{metric.efect_util_mem | fmt_num} &
        \VAR{ (metric.cap_neta_disk / 1000) | fmt_num } TB &
        \VAR{metric.efect_resv_disk_pct | fmt_num} &
        \VAR{metric.efect_util_disk_pct | fmt_num} \\
    \BLOCK{ endfor }
\midrule
    \textbf{Total País} &
    \textbf{\VAR{total_country_metric.cap_neta_cpu} vCPU} &
    \textbf{\VAR{total_country_metric.efect_resv_cpu_pct | fmt_num}} &
    \textbf{\VAR{total_country_metric.efect_util_cpu | fmt_num}} &
    \textbf{\VAR{ (total_country_metric.cap_neta_mem / 1000) | fmt_num } TB} &
    \textbf{\VAR{total_country_metric.efect_resv_mem_pct | fmt_num}} &
    \textbf{\VAR{total_country_metric.efect_util_mem | fmt_num}} &
    \textbf{\VAR{ (total_country_metric.cap_neta_disk / 1000) | fmt_num } TB} &
    \textbf{\VAR{total_country_metric.efect_resv_disk_pct | fmt_num}} &
    \textbf{\VAR{total_country_metric.efect_util_disk_pct | fmt_num}} \\
\bottomrule
\end{tabular}%
}
\end{table}


\textbf{Interpretacion de la matriz:} el eje X representa la \textbf{utilización efectiva} y el eje Y la \textbf{reserva efectiva}. La lectura se organiza en cuatro cuadrantes:
\begin{itemize}
    \item \textbf{Oportunidades de Optimización:} baja utilización efectiva con alta reserva efectiva.
    \item \textbf{Uso eficiente de Reserva / Capacidad de Crecimiento Limitado:} alta utilización efectiva con alta reserva efectiva.
    \item \textbf{Disponibilidad de Infraestructura:} baja utilización efectiva con baja reserva efectiva.
    \item \textbf{Oportunidad de mejoras Operacionales:} alta utilización efectiva con baja reserva efectiva.
\end{itemize}


\noindent La siguiente tabla resume la capacidad y el nivel de utilización del almacenamiento compartido (NAS) disponible a nivel nacional, agrupado por región.

\begin{table}[H]
\centering
\caption{Almacenamiento Compartido (NAS) por Región}
\label{tab:nas_storage}
\resizebox{0.8\textwidth}{!}{%
\begin{tabular}{@{}lccc@{}}
\toprule
\textbf{Región} & \textbf{Capacidad Total} & \textbf{Utilización} & \textbf{Utilización (\%)} \\
\midrule
    \BLOCK{ for storage in nas_storages }
        Región \VAR{storage.region} &
        \VAR{storage.capacity_total_tib | fmt_num} TB &
        \VAR{storage.capacity_used_tib | fmt_num} TB &
        \VAR{storage.capacity_used_pct | fmt_num} \\
    \BLOCK{ endfor }
\midrule
    \textbf{Total País} &
    \textbf{\VAR{total_nas_storage.capacity_total_tib | fmt_num} TB} &
    \textbf{\VAR{total_nas_storage.capacity_used_tib | fmt_num} TB} &
    \textbf{\VAR{total_nas_storage.capacity_used_pct | fmt_num}} \\
\bottomrule
\end{tabular}%
}
\end{table}




\section{Análisis de Recursos por Región}


\subsection{Desglose de Recursos}

Esta sección presenta el desglose detallado de la capacidad por \textbf{Región} a nivel nacional para CPU, Memoria y Disco. La visualización descompone la capacidad total de cada región en cinco categorías clave:

\begin{itemize}
    \setlength\itemsep{0em}
    \item \textbf{Reservado:} Recursos efectivamente comprometidos o en uso por las máquinas virtuales desplegadas.
    \item \textbf{Fragmentación:} Recursos remanentes en servidores productivos que, por ser insuficientes, no pueden alojar nuevas instancias de VMs estándar.
    \item \textbf{Libre:} Capacidad remanente en los servidores activos, efectivamente disponible para el despliegue inmediato de nuevas máquinas virtuales.
    \item \textbf{Sistema:} Corresponde a los recursos reservados para el funcionamiento del sistema operativo del servidor y la capa de virtualización. Estos recursos no son utilizables para la carga de VNFs.}
    \item \textbf{Spare:} Capacidad asociada a servidores designados para failover. Se utiliza el criterio de considerar \textit{Spare} a todo servidor que no tenga ninguna VM instanciada.
\end{itemize}

A su vez, en la figura \ref{fig:servers_per_region} se detalla la cantidad de servidores por región indicando si los mismos son activos (contienen VMs en uso) o spare.

\begin{figure}[H]
\centering
\makebox[\textwidth][c]{\includegraphics[width=0.9\textwidth]{\detokenize{\VAR{fig5_path}}}}
\caption{Cantidad de Servidores por Región: Activo / Spare}
\label{fig:servers_per_region}
\end{figure}

\begin{figure}[H]
\centering
\makebox[\textwidth][c]{\includegraphics[width=1.3\textwidth]{\detokenize{\VAR{fig2_path}}}}
\caption{Desglose de Capacidad por Región: Sistema, Spare, Fragmentación, Reservado y Libre}
\label{fig:region_usage_rsc}
\end{figure}




\subsection{Utilización de Recursos}

Esta sección analiza la utilización de los recursos por región a nivel nacional, diferenciando entre la carga operativa local y la carga proyectada ante escenarios de contingencia. Se definen dos métricas clave para este análisis:

\begin{itemize}
    \setlength\itemsep{0em}
    \item \textbf{Utilización Local:} Representa el consumo de recursos de las VMs en relación con los cores asignados. Para CPU y Memoria, se calcula tomando el percentil 95 (P95) de la utilización agrupada por hora en una ventana de 14 días. Para el Disco, se considera únicamente la última muestra de utilización disponible.
    \item \textbf{Utilización Efectiva:} Corresponde a la utilización local más la carga adicional estimada que la región debería absorber en un escenario de failover. Este cálculo considera la caída de un Data Center redundante y la redistribución de tráfico, según las políticas de redundancia definidas para cada VNF.
\end{itemize}

\begin{figure}[H]
    \centering
    \makebox[\textwidth][c]{\includegraphics[width=1.3\textwidth]{\detokenize{\VAR{fig3_path}}}}
    \caption{Porcentaje de Utilización por Región: Local vs Efectiva (CPU, Memoria y Disco)}
    \label{fig:region_usage_effective}
\end{figure}

\begin{table}[H]
\centering
\caption{Utilización Efectiva y Local Agregada de VMs por Región. \protect\\ \small{\textit{Representa la carga consolidada de todas las VMs alojadas en cada región.}}}
\label{tab:region_utilization}
\resizebox{\textwidth}{!}{%
\begin{tabular}{lccccc}
\toprule
\textbf{Región} &
\textbf{Util. Efect. CPU (\%)} &
\textbf{Util. Efect. MEM (\%)} &
\textbf{Util. Local CPU (\%)} &
\textbf{Util. Local MEM (\%)} &
\textbf{Util. Disk (\%)} \\
\midrule
    \BLOCK{ for vm_util in vm_utilization }
        Región \VAR{vm_util.region} &
        \VAR{vm_util.efect_util_cpu | fmt_num} &
        \VAR{vm_util.efect_util_mem | fmt_num} &
        \VAR{vm_util.cpu_p95_pct | fmt_num} &
        \VAR{vm_util.mem_p95_pct | fmt_num} &
        \VAR{vm_util.efect_util_disk_pct | fmt_num} \\
    \BLOCK{ endfor }
\midrule
    \textbf{Promedio País} &
    \textbf{\VAR{avg_vm_utilization.efect_util_cpu | fmt_num}} &
    \textbf{\VAR{avg_vm_utilization.efect_util_mem | fmt_num}} &
    \textbf{N/A} &
    \textbf{N/A} &
    \textbf{\VAR{avg_vm_utilization.efect_util_disk_pct | fmt_num}} \\
\bottomrule
\end{tabular}%
}
\end{table}



\subsection{Distribución de VNFs por Región}

Esta sección presenta la distribución de \textbf{tipos de VNF} en las distintas regiones de \VAR{country}. La visualización permite identificar la concentración y dispersión del despliegue de VNFs a nivel nacional, facilitando el análisis de balanceo de carga entre regiones.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{\detokenize{\VAR{fig_vnf_dc_distribution}}}
    \caption{Distribución de VNFs por Región: \VAR{country}}
    \label{fig:vnf_region_distribution}
\end{figure}

\section{Análisis de Carga por Instancia de VNF}

La siguiente tabla presenta un resumen de la carga por \textbf{Instancia de VNF}, destacando los valores más altos de utilización de CPU (P95) dentro del periodo analizado a nivel nacional, con el objetivo de apoyar la priorización de revisión y ajuste de capacidad.


\begin{table}[H]
\centering
\caption{Top 15 VNFs por Utilización de CPU (P95)}
\label{tab:top15_vnf_country}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}cllrrrrr@{}}
\toprule
Región & Instancia de VNF & Data Center & Utilizacion Local CPU & CPU Efec. & Utilizacion Local RAM & RAM Efec. & Disco \\
 & & & (\%) & (\%) & (\%) & (\%) & (\%) \\
\midrule
    \BLOCK{ for vnf in top15_vnf_cpu_p95_country }
        \VAR{vnf.region} &
        \VAR{vnf.name} &
        \VAR{vnf.datacenter} &
        \VAR{vnf.cpu_p95 | fmt_num} &
        \VAR{vnf.efect_util_cpu_pct | fmt_num} &
        \VAR{vnf.ram_p95 | fmt_num} &
        \VAR{vnf.efect_util_mem_pct | fmt_num} &
        \VAR{vnf.efect_util_disk_pct | fmt_num} \\
    \BLOCK{ endfor }
\bottomrule
\end{tabular}%
}
\end{table}


\section{Oportunidades de Mejora}

Esta sección identifica \textbf{Instancias de VNF} con una alta proporción de recursos reservados que permanecen sin uso (recursos ociosos). El objetivo es identificar posibles oportunidades de optimización y reasignación de capacidad.

\textbf{Metodología:}
\begin{itemize}
    \item \textbf{Recursos Ociosos (Idle):} Se calculan como la diferencia entre recursos \textbf{reservados} y \textbf{utilización efectiva}. Como metrica para el calculo de CPU y RAM se recurrea a la utilización efectiva y para el disco se estima la capacidad libre a partir del porcentaje de uso reportado.
    \item \textbf{Criterio de Ranking:} Se seleccionan los \textbf{Top 10} tipos de VNF con mayor valor absoluto de recursos ociosos (vCPUs, GB de RAM, TB de disco), con el fin de priorizar el impacto potencial en la capacidad de la Región.
    \item \textbf{Visualización:} Se presenta un resumen visual de los Top 10 tipos de VNF con mayor cantidad de recursos ociosos, categorizados por tipo de recurso (CPU, RAM, Disco), para facilitar la identificación rápida de las VNFs más candidatas a optimización.
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=0.95\textwidth]{\detokenize{\VAR{top_cpu_path}}}
\caption{Top 10 VNFs: CPU Ociosa (Resumen Visual)}
\label{fig:top_cpu_idle}
\end{figure}

\begin{table}[H]
\centering
\caption{Top 10 VNFcs: Region \VAR{region} Cantidad de CPU Ociosa}
\label{tab:top10_idle_cpu}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lcccc@{}}
\toprule
Instancia de VNFc & vCPUs Reservadas & vCPUs Ociosas & Util. Efec. CPU & Util Local CPU \\
\midrule
\BLOCK{ for r in top10_idle_cpu }
\VAR{r.vnf_instance} & \VAR{r.resv_cpu} & \VAR{r.idle_cpu_str} & \VAR{r.util_cpu_str} & \VAR{r.util_local_cpu_str} \\
\BLOCK{ endfor }
\bottomrule
\end{tabular}%
}
\end{table}



\begin{figure}[H]
\centering
\includegraphics[width=0.95\textwidth]{\detokenize{\VAR{top_mem_path}}}
\caption{Top 10 VNFs: Memoria RAM Ociosa (Resumen Visual)}
\label{fig:top_ram_idle}
\end{figure}

\begin{table}[H]
\centering
\caption{Top 10 VNFcs: Region \VAR{region} Cantidad de Memoria RAM Ociosa}
\label{tab:top10_idle_mem}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lcccc@{}}
\toprule
Instancia de VNFc & RAM Reservada (GB) & RAM Ociosa (GB) & Util. Efec. MEM & Util Local MEM \\
\midrule
\BLOCK{ for r in top10_idle_mem }
\VAR{r.vnf_instance} & \VAR{r.resv_mem} & \VAR{r.idle_mem_str} & \VAR{r.util_mem_str} & \VAR{r.util_local_mem_str} \\
\BLOCK{ endfor }
\bottomrule
\end{tabular}%
}
\end{table}



\begin{figure}[H]
\centering
\includegraphics[width=0.95\textwidth]{\detokenize{\VAR{top_disk_path}}}
\caption{Top 10 VNFs: Almacenamiento Ocioso (Resumen Visual)}
\label{fig:top_disk_idle}
\end{figure}

\begin{table}[H]
\centering
\caption{Top 10 VNFcs: Region \VAR{region} Cantidad de Almacenamiento Ocioso}
\label{tab:top10_idle_disk}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lccc@{}}
\toprule
Instancia de VNFc & Disco Reservado (GB) & Disco Ocioso (GB) & Util. Disco \\
\midrule
\BLOCK{ for r in top10_idle_disk }
\VAR{r.vnf_instance} & \VAR{r.resv_disk} & \VAR{r.idle_disk_str} & \VAR{r.util_disk_str} \\
\BLOCK{ endfor }
\bottomrule
\end{tabular}%
}
\end{table}



\appendix
\newpage
\section{Anexo: Metodología de Cálculo}

\subsection{Análisis de Redundancia Geográfica (Failover)}

Failover es un caso donde múltiples VNFs según su esquema de redundancia geográfica en caso de la caída de un Datacenter del pool redistribuyen su tráfico a las VNFs y por ende a los DCs de la Región \VAR{region}. Esto se ve solo como un aumento de la utilización efectiva y no de la reserva Efectiva dado que la reserva de VMs no escala.

La siguiente tabla detalla el esquema de redundancia geográfica para la Región \VAR{region}:

\begin{table}[H]
\centering
\caption{Tabla de Redundancias Geográficas - Región \VAR{region}}
\label{tab:geo_redundancy_r\VAR{region}}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lll@{}}
\toprule
\textbf{VNF} & \textbf{Sitios de Redundancia} & \textbf{Tipo de Redundancia} \\
\midrule
    \BLOCK{ for row in redundancy_table }
        \BLOCK{ if row.vnf != "N/A" and row.vnf != "n/a" }
            \VAR{ row.vnf | default("n/a") } &
            \VAR{ row.sites | default("n/a") } &
            \VAR{ row.redundancy | default("n/a") } \\
        \BLOCK{ endif }
    \BLOCK{ endfor }
\bottomrule
\end{tabular}%
}
\end{table}


\subsection{Definiciones}
\label{sec:definiciones_utilizacion}

\begin{itemize}
    \item \textbf{Failover:} Escenario de contingencia en el que, ante la caída del Data Center más grande de un \textit{pool} de redundancia geográfica, el tráfico/carga se redistribuye parcial o totalmente hacia las VNFs del resto de Data Centers del \textit{pool}.
    \item \textbf{Utilización Efectiva:} Carga proyectada para la Región que combina el uso local observado en las VMs (p. ej., P95 de CPU/RAM) con una componente adicional asociada al \textbf{failover}. Esta componente se estima por tipo de VNF y por recurso (CPU/RAM) mediante un indicador de traspaso de carga, que determina qué proporción de la carga del Data Center fallido se reflejaría como incremento de utilización en la Región.
    \item \textbf{Reserva Efectiva:} Margen de recursos reservado a nivel de VMs respecto a la capacidad \textbf{neta} de los servidores; para este cálculo se excluye la capacidad clasificada como \textit{spare}.
\end{itemize}

\subsection{Alcance y Configuración}
El análisis se basa en el siguiente alcance y parámetros de configuración:
\begin{itemize}
    \item \textbf{Agregación Regional:} La Región \VAR{region} se define como la agregación de recursos de los Data Centers: \VAR{dc_list_str}.
    \item \textbf{Clusters de Reserva:} Los clusters designados como \texttt{ceeaz06} se clasifican como capacidad de Reserva (Spare). Estos recursos se excluyen de los cálculos de Capacidad Efectiva Disponible de la Región ($EC_{Region}$) agregado para reflejar la capacidad de producción activa.
    \item \textbf{Factores de Overcommit:} Se aplica un factor de overcommit de 1 ($overcommit = 1$) tanto para recursos de CPU como de Memoria, derivado del análisis del hipervisor.
\end{itemize}

Las métricas de capacidad efectiva y reserva se calculan de la siguiente manera:

\textbf{Definiciones:}
\begin{itemize}
    \item $m = 0.05$ (Margen de Seguridad, 5\%)
    \item $VCPU_s$: vCPUs disponibles para el servidor
    \item $Reserve_{CPU}$: vCPUs reservadas por servidor
    \item $NC$: Capacidad Neta (Total vCPU o RAM sin los servidores de spare)
    \item $RC$: Capacidad Bruta (Total vCPU o RAM)
    \item $overcommit_{CPU}$ o $overcommit_{MEM}$: Factor de overcommit para CPU o Memoria
\end{itemize}

\subsection{Cálculos a Nivel de Servidor}
\begin{itemize}
    \item \textbf{Capacidad Efectiva Disponible (EC) - CPU:}
    $$ EC_{CPU} = VCPU_s \times overcommit_{CPU} - Reserve_{CPU} - m \times VCPU_s $$
    
    \item \textbf{Porcentaje de Capacidad Efectiva Disponible (ECP) - CPU:}
    $$ ECP_{CPU} = \frac{EC_{CPU}}{VCPU_s \times overcommit_{CPU}} \times 100 $$

    \item \textbf{Capacidad Efectiva Disponible (EC) - Memoria:}
    $$ EC_{MEM} = RAM_s \times overcommit_{MEM} - Reserve_{MEM} - m \times RAM_s $$
    
    \item \textbf{Porcentaje de Capacidad Efectiva Disponible (ECP) - Memoria:}
    $$ ECP_{MEM} = \frac{EC_{MEM}}{RAM_s \times overcommit_{MEM}} \times 100 $$
    
    \item \textbf{Reserva Efectiva (ER):}
    $$ ER = 100 - ECP $$
\end{itemize}

Para los calculos de utilización efectiva ver Anexo (\ref{sec:calculo_utilizacion_efectiva}).

\subsection{Cálculos a Nivel de Data Center}
\begin{itemize}
    \item \textbf{Capacidad Neta (NC):}
    $$ NC = \sum Capacity_{serv} \quad \text{(para todos los servidores en el DC que no sean de spare)} $$
    
    \item \textbf{Capacidad Efectiva Disponible del DC ($EC_{DC}$):}
    $$ EC_{DC} = \sum EC_{serv} \quad \text{(para todos los servidores en el DC)} $$
    
    \item \textbf{Porcentaje de Capacidad Efectiva Disponible del DC ($ECP_{DC}$):}
    $$ ECP_{DC} = \frac{EC_{DC}}{NC} \times 100 $$
    
    \item \textbf{Reserva Efectiva del DC (ER):}
    $$ ER = 100 - ECP_{DC} $$
\end{itemize}

Para los calculos de utilización efectiva ver Anexo (\ref{sec:calculo_utilizacion_efectiva}).

\subsection{Cálculo de Utilización Efectiva}
\label{sec:calculo_utilizacion_efectiva}
La Utilización Efectiva se define como la carga proyectada que debe soportar el Data Center en un escenario de estrés máximo, combinando la operación normal con situaciones de contingencia geográfica.

El cálculo se realiza considerando los siguientes componentes:
\begin{itemize}
    \item \textbf{Utilizacion Local:} Se parte del percentil 95 (P95) de utilización de CPU y Memoria de las VMs existentes en el Data Center, se agrupa por hora y del mismo se toma el máximo.
    \item \textbf{Carga de Contingencia:} Es la carga que la VNF debe aboserver en caso de un failover, para su calculo se simula la caída del Data Center más grande dentro del pool de redundancia geográfica. El tráfico de las VNFs afectadas se redistribuye (parcial o totalmente) hacia las VNFs de los DC en dicho pool. 
    \item \textbf{Indicador de Traspaso de Carga:} Para cada VNF y tipo de recurso (CPU/RAM) se define un factor específico que determina qué proporción de la carga del DC fallido se vería reflejada efectivamente como un aumento de utilización en este Data Center.
\end{itemize}

$$ \text{Utilización Efectiva} = \text{Utilizacion Local} + (\text{Carga de Contingencia} \times \text{Indicador de Traspaso}) $$

\subsection{Clusters Excluidos}
Para el analisis del presente documento se excluyen los siguientes clusters:
\begin{itemize}
    \item Internal
\end{itemize}



\end{document}